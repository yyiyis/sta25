---
title: "5_cox_expand"
author: "YYS"
date: "2025-5-6"
toc: true
number-sections: true
format:
  html:
    theme: litera
    df-print: kable
---

```{r setup}
#| include: false
knitr::opts_chunk$set(warning = F, message = F, dpi = 300)
```

```{r}
#| include: false
rm(list = ls())
```

```{r}
options(scipen = 200)
```

------------------------------------------------------------------------

1.  ç»ˆç‚¹äº‹ä»¶é‡å¤å‘ç”Ÿçš„ç”Ÿå­˜æ¨¡å‹

2.  ç«äº‰é£é™©æ¨¡å‹

3.  æ··æ‚çš„å‰ä¸–ä»Šç”Ÿ

------------------------------------------------------------------------

# load packages

```{r}
library(tidyverse)
library(tidymodels)
library(gtsummary)
library(survival)
library(survminer)
library(frailtypack)
library(DataExplorer)
library(ggsci)
library(cmprsk)
library(tidycmprsk)
library(ggsurvfit)
library(mstate)
```

# Recurrent event

## basic infor

------------------------------------------------------------------------

åŒä¸€ä¸ªä½“, åœ¨è§‚å¯ŸæœŸé—´, **å¤šæ¬¡å‘ç”Ÿ**ç»“å±€äº‹ä»¶ (ç–¾ç—…å¤å‘, å¤šæ¬¡å…¥é™¢, æ„ŸæŸ“, è·Œå€’ )

-   repeat and alive (not terminal)

-   vs ä¹‹å‰çš„ K-M æˆ– Cox, ä»¥å‰å…³æ³¨ä¸€æ¬¡(é¦–æ¬¡) event

-   å› ä¸ºæ˜¯åŒä¸€ä¸ªä½“, æ‰€ä»¥äº‹ä»¶ä¹‹é—´ä¼šæœ‰ç›¸å…³æ€§

-   ä¸¤ä¸ª time:

    -   æ€»æ—¶é—´(ç´¯ç§¯ time, total time, from baseline)

    -   é—´éš”æ—¶é—´(Gap time, from last time)

    -   è¿˜æœ‰ç”¨ æ—¥å†æ—¶é—´ æ¥ç©çš„

------------------------------------------------------------------------

**ä¸€äº›å¸¸ç”¨çš„ model**

-   Andersen-Gill (AG)

    -   å‡è®¾æ¯æ¬¡ event ä¹‹é—´ç‹¬ç«‹ iid (æ‰€ä»¥å¼ºç›¸å…³çš„æ—¶å€™æ²¡æ³•å¼„)

    -   ä½¿ç”¨æ¯æ¬¡çš„èµ·æ­¢æ—¶é—´, æ—¥å†æ—¶é—´

-   Prentice-Williams-Peterson (PWP)

    -   è€ƒè™‘ event å…ˆåé¡ºåº, æ¯ä¸€çº§é£é™©é›†åªåŒ…å«â€œå·²å‘ç”Ÿnæ¬¡â€çš„äºº

    -   GT: Gap time, ä»ä¸Šä¸€æ¬¡å¼€å§‹, ä¸”éƒ½ç§»åŠ¨åˆ°èµ·ç‚¹å»

    -   TT: total time, ä»åŸºçº¿å¼€å§‹

-   Wei-Lin-Weissfeld (WLW)

    -   each event ä¹Ÿè§†ä¸ºç‹¬ç«‹, ç”¨è¾¹é™…ç»“å±€

    -   ä¸ºæ¯ä¸ªäº‹ä»¶é¡ºåºæ‹Ÿåˆå•ç‹¬çš„ Cox (æ‰€ä»¥ç›¸å½“äºä¸è€ƒè™‘é¡ºåº)

    -   ç¨³å¥æ ‡å‡†è¯¯(å…è®¸ä¸ªä½“ä¹‹é—´ç›¸å…³)

    -   ç›´è§‚

    -   é¢å¤–çš„æ•°æ®æ ¼å¼

-   Frailty

    -   åŠ å…¥éšæœºæ•ˆåº”, è€ƒè™‘å¼‚è´¨æ€§

------------------------------------------------------------------------

## simul data

-   æ›´å»ºè®®é‚£çœŸå®ä¸–ç•Œå®è·µæ•°æ®æ¥ç©, æˆ‘æ‰‹é‡Œæ²¡æœ‰, æ‰€ä»¥å°±è¿˜æ˜¯æ¨¡æ‹Ÿäº†

-   æ³¨æ„æ•°æ®ç»“æ„

-   ä¸‹é¢æ˜¯ R é‡Œé¢ è‡ªå¸¦çš„æ•°æ®é›†

è†€èƒ±ç™Œå¤å‘æ•°æ® to demonstrate methodology for recurrent event modelling.

-   Bladder1

    -   full dataset

    -   ä¸‰ç§æ²»ç–—æ–¹æ¡ˆ, æ‰€æœ‰118åå—è¯•è€…çš„å¤å‘ä¿¡æ¯

    -   è§‚å¯Ÿåˆ°çš„æœ€å¤§å¤å‘æ¬¡æ•°ä¸º9æ¬¡(æœ‰ä¸€ä¸ª10æ¬¡çš„)

-   Bladder

    -   ä»…åŒ…å«85åæœ‰éšè®¿è®°å½•ä¸”è¢«åˆ†é…è‡³ç¡«ä»£æ›¿æ³Šï¼ˆthiotepaï¼‰æˆ–å®‰æ…°å‰‚ç»„çš„å—è¯•è€…

    -   å¹¶ä¸”å¯¹æ¯ä½æ‚£è€…æœ€å¤šåªä¿ç•™å‰å››æ¬¡å¤å‘äº‹ä»¶

    -   status 1: å¤å‘, 0: å…¶ä»–æƒ…å†µ(åŒ…æ‹¬å› ä»»ä½•åŸå› æ­»äº¡)

    -   è¯¥æ•°æ®é›†é‡‡ç”¨äº†Weiã€Lin å’Œ Weissfeld (WLW) æå‡ºçš„â€œç«äº‰é£é™©â€æ ¼å¼è¿›è¡Œæ•´ç†

-   Bladder2

    -   åŒ Bladder subset

    -   formatted in the (start, stop\] or Anderson-Gill style

    -   Note that a issue in transforming from the WLW to the AG style data set

        -   `?bladder` for detail

```{r}
data("bladder")
```

------------------------------------------------------------------------

-   **bladder1**

    -   treatment æ²»ç–—: Placebo, pyridoxine (vitamin B6), or thiotepa

    -   number åˆå§‹æ•°é‡: Initial number of tumours (8=8 or more)

    -   size åˆå§‹å¤§å° of æœ€å¤§çš„é‚£ä¸ª: Size (cm) of largest initial tumour

    -   recur å¤å‘æ¬¡æ•°: Number of recurrences

    -   start,stop ä¸¤ä¸ªæ—¶é—´: The start and end time of each time interval

    -   status ç»“å±€: End of interval code, 0=censored, **1=recurrence**, 2=death from bladder disease, 3=death other/unknown cause

    -   rtumor æŸæ¬¡å¤å‘çš„æ•°é‡: Number of tumors found at the time of a recurrence

    -   rsize æœ€å¤§çš„ size : Size of largest tumor at a recurrence

    -   enum æ€»æ—¶é—´æ•°: Event number (observation number within patient)

**çœ‹ä¸€ä¸‹bladder1 çš„æ•°æ®æ ¼å¼, è§‚å¯Ÿä¸€ä¸‹ recurrent æ˜¯æ€ä¹ˆè¡¨ç¤ºçš„**

```{r}
bladder1 |> 
  glimpse()
```

è¿™ä¸ªæ•°æ®é›†é‡Œé¢å‘ç”Ÿ `2=death from bladder disease` çš„å¾ˆå°‘, åªæœ‰2ä¸ª

```{r}
bladder1 |> 
  filter(id %in% c(5, 6, 10, 14)) 
```

------------------------------------------------------------------------

-   **bladder1**

    -   rx: Treatment 1=placebo 2=thiotepa

    -   number: Initial number of tumours (8=8 or more)

    -   size: size (cm) of largest initial tumour

    -   stop: recurrence or censoring time

    -   enum: which recurrence (up to 4)

```{r}
bladder |> head(12)
```

------------------------------------------------------------------------

-   **bladder2**

    -   rx: Treatment 1=placebo 2=thiotepa

    -   number: Initial number of tumours (8=8 or more)

    -   size: size (cm) of largest initial tumour

    -   start: start of interval (0 or previous recurrence time)

    -   stop: recurrence or censoring time

    -   enum: which recurrence (up to 4)

```{r}
#| eval: false
bladder2 |> view()
```

```{r}
bladder2 |> 
  filter(id %in% c(7:9)) 
```

------------------------------------------------------------------------

## modelling

```{r}
#| eval: false
bladder2 |> glimpse()
bladder2 |> view()
```

### desc

**1. åœ¨ model ä¹‹å‰, æè¿°æ˜¯ä¸å¯å°‘çš„**

```{r}
#| eval: false
bladder1 |> view()
```

å½“ç„¶è¿™é‡Œæœ‰ä¸€ä¸ªå°ç»†èŠ‚æ˜¯è¯´, è¿™äº›è¢«é‡å¤è®°å½•çš„ id, å» distinct å°±å¥½äº†

```{r}
n_distinct(bladder$id)

bladder |> 
  distinct(id, rx) |> 
  count(rx)

bladder |> 
  distinct(id, .keep_all = T) |> 
  summarise(
    mean_number = mean(number),
    median_number = median(number),
    mean_size = mean(size),
    median_size = median(size)
  )
```

then è¿™é‡Œæˆ‘ä»¬ä»…ä½¿ç”¨ç¬¬ä¸€æ¬¡äº‹ä»¶ç»˜åˆ¶ KM æ›²çº¿

```{r}
#| fig-width: 8
#| fig-height: 8
bladder_first <- bladder2 |> filter(enum == 1)

fit_km <- survfit(Surv(stop, enum > 0) ~ rx, data = bladder_first)

ggsurvplot(fit_km, data = bladder_first,
           conf.int = T, risk.table = T,
           palette = c("#1A4486", "#DA3B21"), 
           legend.labs = c("Placebo", "Thiotepa"),
           title = "Time to First Recurrence (KM Estimate)")
```

### fit_first

```{r}
fit_first <- coxph(Surv(stop, event = (enum > 0)) ~ rx + number + size, 
                   data = bladder_first)

fit_first |> summary()
```

**note:**

æ³¨æ„ä¸€ä¸ªç»†èŠ‚: `enum > 0` (é˜²å¾¡å¼å†™æ³•ï¼Œç¡®ä¿é€»è¾‘æ­£ç¡®)

-   è¿™ä¸ªåœ¨ä»…ä½¿ç”¨ç¬¬ä¸€æ¬¡ time æ—¶å€™çœ‹ä¸å‡ºæ¥ä½œç”¨, åé¢å»ºæ¨¡æ—¶å€™å°±èƒ½çœ‹å‡ºæ¥äº†

-   äº‹å®ä¸Š, è¿™æ˜¯ä¸€ä¸ªçº¦å®šæ€§è§„èŒƒå†™æ³•, æ¥å¼ºè°ƒäº‹ä»¶å®šä¹‰

-   `Surv(start, stop, event = ...)` é‡Œé¢, event åº”æ˜¯0/1å˜é‡, indicating è¯¥åŒºé—´ç»“æŸæ—¶æ˜¯å¦å‘ç”Ÿäº†**ç»ˆç‚¹äº‹ä»¶(å¦‚å¤å‘)**

    -   è¢«å¤„ç†è¿‡çš„`bladder2`ä¸­æ¯è¡Œéƒ½è¡¨ç¤ºä¸€ä¸ª recurrence, ä½†å¹¶æ²¡æœ‰æ˜¾å¼çš„ `status`å˜é‡

        -   `bladder2 |> mutate(event = 1)`

    -   å¦‚æœåªå†™ `event = enum`, é‚£å°±æ˜¯ 1, 2, 3, 4ï¼Œä¼šè¢«é”™è¯¯è¯†åˆ«ä¸ºâ€œæ­»äº¡â€æˆ–â€œå¤šçº§äº‹ä»¶â€ï¼›

    -   ç”¨ (enum \> 0) æ˜¯ä¸€ç§æ–¹å¼æ¥ç”Ÿæˆä¸€ä¸ª 0/1 çš„é€»è¾‘å˜é‡ (`enum > 0 == TRUE`), å‘Šè¯‰æ¨¡å‹è¿™æ¡è®°å½•æ˜¯å¦æ˜¯ä¸€æ¬¡å¤å‘(å§‹ç»ˆä¸º 1)

------------------------------------------------------------------------

### fit_AG

**2. è¿™é‡Œæˆ‘ä»¬ç”¨äº† Andersen-Gill (AG) model**

ç¬¬äºŒä¸ªç»†èŠ‚: `cluster(id)`

-   ç”¨äº†robust sandwich variance estimate

-   Sanwich åœ¨äºŒé¡¹åˆ†å¸ƒå‡ºç° *overdispersion* æ—¶å€™ä¹Ÿç”¨çš„å¾ˆå¤š

```{r}
fit_AG <- coxph(Surv(start, stop, event = (enum > 0)) ~ rx + number + size + cluster(id),
                data = bladder2)

fit_AG |> summary()
```

```{r}
bladder2 <- bladder2 |> mutate(event = 1)
fit_ag <- coxph(Surv(start, stop, event) ~ rx + number + size + cluster(id),
                data = bladder2)

fit_ag |> summary()
```

```{r}
yysfun_ORCIP <- function(model) {
  model |>
    tidy() |>
    mutate(
      HR = exp(estimate),
      lower = exp(estimate - 1.96 * robust.se),
      upper = exp(estimate + 1.96 * robust.se),
      CI = sprintf("%.2f (%.2f, %.2f)", HR, lower, upper), 
      P = case_when(p.value < 0.001 ~ "< 0.001", 
                    T ~ sprintf("%.3f", p.value))
      )|>
    dplyr::select(Variable = term, CI, P, 
                  HR, lower, upper)
}
```

```{r}
#| eval: false
yysfun_ORCIP(fit_AG)
```

**3. ä½¿ç”¨å…¶ä»– model**

-   AG æ˜¯æœ‰ä¸€äº› assumption çš„(è§†ä¸ºç‹¬ç«‹, ä¸”æ²¡æ³•æé¡ºåº), ä½†æ˜¯åœ¨ç°å®ä¸­æœªå¿…èƒ½è¢«æ»¡è¶³

### fit_PWP

-   PWP è€ƒè™‘æ—¶é—´é¡ºåºå’Œä¾èµ–, æ‰€ä»¥æ˜¯æ¡ä»¶æ¨¡å‹

-   æ ¸å¿ƒæ˜¯ `strata(enum)` æŒ‰ç…§äº‹ä»¶ç¼–å·åˆ†å±‚

a.  total time

```{r}
fit_PWP_TT <- coxph(Surv(start, stop, event) ~ 
                      rx + number + size + strata(enum) + cluster(id),
                    data = bladder2)
fit_PWP_TT
```

b.  gap time

ä¸¤æ¬¡äº‹ä»¶ä¹‹é—´çš„æ—¶é—´, ç„¶åç»™æ‹‰å›èµ·ç‚¹å»

```{r}
bladder2_gap <- bladder2 |> 
  mutate(gap_start = 0,
         gap_stop = stop - start)

fit_PWP_GT <- coxph(Surv(gap_start, gap_stop, event) ~
                      rx + number + size + strata(enum) + cluster(id),
                    data = bladder2_gap)
fit_PWP_GT
```

### fit_WLW

```{r}
fit_WLW <- coxph(Surv(stop, enum > 0) ~
                   rx + number + size + strata(enum) + cluster(id),
                 data = bladder)
fit_WLW
```

### fit_Frailty

å¼•å…¥éšæœºæ•ˆåº”(frailty term)å»ºæ¨¡ä¸ªä½“é—´å¼‚è´¨æ€§, å…è®¸åŒä¸€äººé‡å¤äº‹ä»¶ä¹‹é—´æœ‰å…³è”ã€‚

```{r}
fit_Frailty <- coxph(Surv(start, stop, event) ~
                       rx + number + size + frailty(id), 
                     data = bladder2)
fit_Frailty
```

------------------------------------------------------------------------

## res

```{r}
#| eval: false
fit_AG |> yysfun_ORCIP() |> mutate(Model = "AG")
fit_PWP_GT |> yysfun_ORCIP() |> mutate(Model = "PWP_GT")
fit_PWP_TT |> yysfun_ORCIP() |> mutate(Model = "PWP_TT")
fit_WLW |> yysfun_ORCIP() |> mutate(Model = "WLW")
```

```{r}
yysfun_ORCIP2 <- function(model, model_name) {
  model |>
    tidy() |>
    mutate(
      HR = exp(estimate),
      lower = exp(estimate - 1.96 * robust.se),
      upper = exp(estimate + 1.96 * robust.se),
      CI = sprintf("%.2f (%.2f, %.2f)", HR, lower, upper), 
      P = case_when(p.value < 0.001 ~ "< 0.001", 
                    TRUE ~ sprintf("%.3f", p.value)),
      Model = model_name
    ) |>
    dplyr::select(Model, Variable = term, CI, P, 
                  HR, lower, upper)
}
```

```{r}
models <- list(fit_AG, fit_PWP_GT, fit_PWP_TT, fit_WLW)
names <- c("AG", "PWP_GT", "PWP_TT", "WLW")

res_4 <- map2_dfr(models, names, yysfun_ORCIP2)
```

------------------------------------------------------------------------

```{r}
yysfun_ORCIP3 <- function(model) {
  model |>
    tidy() |>
    mutate(
      HR = exp(estimate),
      lower = exp(estimate - 1.96 * std.error),
      upper = exp(estimate + 1.96 * std.error),
      CI = sprintf("%.2f (%.2f, %.2f)", HR, lower, upper), 
      P = case_when(p.value < 0.001 ~ "< 0.001", 
                    T ~ sprintf("%.3f", p.value))
      )|>
    dplyr::select(Variable = term, CI, P, 
                  HR, lower, upper)
}
```

```{r}
final_res <- rbind(
  fit_first |> yysfun_ORCIP3() |>
    mutate(Model = "First", .before = 1),
  
  res_4,
  fit_Frailty |> yysfun_ORCIP3() |>
    filter(Variable != "frailty(id)") |> 
    mutate(Model = "Frailty", .before = 1)
)
final_res |> 
  dplyr::select(Model, Variable,  `HR (95% CI)` = CI, P)
```

```{r}
final_res |> 
  mutate(Model = fct_relevel(Model, "First")) |> 
  ggplot(aes(x = Variable, y = HR, color = Model)) + 
  geom_point(size = 2, 
             position = position_dodge(width = 0.8)) + 
  geom_errorbar(aes(ymin = lower, 
                    ymax = upper), 
                width = 0.6, 
                size = 1, 
                position = position_dodge(width = 0.8)) + 
  scale_color_lancet() + 
  labs(x = NULL, y = "HR (95% CI)") + 
  theme(axis.title = element_text(size = 14), 
        axis.text = element_text(size = 14), 
        legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12), 
        # legend.position = c(0.15, 0.3)
        )
```

------------------------------------------------------------------------

# Competing risk

## note

éœ€è¦åšæ¨¡æ‹Ÿ, è®²æ¸…æ¥š CIF, FG, ä»¥åŠ MS é‡Œé¢å…·ä½“åœ¨å¹²ä»€ä¹ˆäº‹æƒ…

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä»–ä»¬èƒ½å¤Ÿå¤„ç† competing risk


## basic infor

ç«äº‰é£é™©(å¤šä¸ª**äº’æ–¥**äº‹ä»¶): æ­»äºå…¶ä»–; only one can happen first

è€Œä¼ ç»Ÿçš„ Cox åªå…³å¿ƒä¸€ä¸ªç»ˆç‚¹äº‹ä»¶

ç°å®ä¸­, ç ”ç©¶å¯¹è±¡ä¼šå› å¤šç§åŸå› (ç«äº‰é£é™©)é€€å‡ºè§‚å¯Ÿ, è¿™äº›åŸå› ä¹‹é—´ä¹Ÿä¼šç›¸äº’å½±å“

-   ç«äº‰å‘ç”Ÿ(äº’æ–¥), ä¼šå½±å“(é˜»æ­¢)å…¶ä»–äº‹ä»¶å‘ç”Ÿ

    -   ä¿¡æ¯åˆ å¤±, **å½±å“ç›®æ ‡äº‹ä»¶ç”Ÿå­˜æ¦‚ç‡ä¼°è®¡**

-   è€Œä¼ ç»Ÿ Cox å‡è®¾å…¶ä»–äº‹ä»¶ä¸å½±å“ç›®æ ‡äº‹ä»¶å‘ç”Ÿ(æ¦‚ç‡)

-   ä¸¾ä¸ªğŸŒ°

    -   ç›®æ ‡äº‹ä»¶: cancer death

    -   competing event: death of other disease or loss to follow-up

    -   è¿™æ—¶å€™å¦‚æœç›´æ¥ç”¨K-Mä¼°è®¡ç”Ÿå­˜ç‡, å°†å…¶ä»–äº‹ä»¶éƒ½è§†ä¸º censored, ä¼š

        -   é«˜ä¼°/ä½ä¼°? (çœ‹åé¢çš„ä¾‹å­)

        -   why: censored æ”¹å˜äº†åé¢äº‹ä»¶å‘ç”Ÿçš„æ¦‚ç‡

**æ ¸å¿ƒå¤„ç†**:

æ­£ç¡®ä¼°è®¡ specific event çš„ Cumulative Incidence Function (CIF), åŒæ—¶è€ƒè™‘ event ä¹‹é—´çš„ç›¸äº’ä½œç”¨

1.  CIF

åœ¨æ—¶é—´ t ä¹‹å‰, æŸç‰¹å®š event å‘ç”Ÿçš„æ¦‚ç‡

$$CIF_k(t) = P(T \leq t, D = k) \tag{1}$$

-   D = k è¡¨ç¤ºç‰¹å®š event

-   æ‰€æœ‰ event çš„ CIF åŠ èµ·æ¥ $\leq 1$


2.  Cause-Specific Hazard

è¿™ä¸ªåŒä¹‹å‰Coxçš„ $h_k(t)$


***

**å¸¸ç”¨çš„ model**

-   Fine-Gray (è¿™ä¸ªåœ¨è®ºæ–‡é‡Œé¢ä¹Ÿå¾ˆå¸¸ç”¨) based on Subdistribution

    - åå˜é‡ subdistribution hazard ratio, SHR, ç±»ä¼¼äº Cox é‡Œé¢çš„ PH (ä¸éšæ—¶é—´å˜åŒ–)
    
        - å¯ä»¥çœ‹æ®‹å·®, æˆ–è€…åå˜é‡ä¸æ—¶é—´çš„äº¤äº’é¡¹, æˆ–è€…çœ‹CIF æ›²çº¿ (å¾ˆç±»ä¼¼ Cox é‡Œé¢çš„åšæ³•)
        
    - éœ€è¦æ­£ç¡®æŒ‡å®šæ‰€æœ‰ç«äº‰äº‹ä»¶(ä¸è¦é—æ¼æˆ–é”™åˆ†), ä¸”äº‹ä»¶ä¹‹é—´äº’æ–¥
    
    - å…¶ä»–çš„æ¨¡å‹å‡è®¾åŒä¹‹å‰(ç‹¬ç«‹åˆ å¤±, å……åˆ†äº‹ä»¶æ•°, å…±çº¿æ€§ç­‰ç­‰)
    
    - ç›´æ¥å¯¹ç‰¹å®šäº‹ä»¶å»ºæ¨¡

-   Cause-specific Cox

    - è¿™ä¸ªå°±æ˜¯å•ä¸ªç»“å±€åˆ†åˆ«å»åšäº†

-   Aalen-Johansen or Multi-State Model



**note**: a new package published in Aug, 2024 named `tidycmprsk`

-   wraps the `cmprsk` package

-   However, the time interaction features available in `cmprsk::crr()` is not available in `tidycmprsk`

## simu data


`tidycmprsk::trial`: A dataset containing the baseline characteristics of 200 patients who received Drug A or Drug B. Dataset also contains the outcome of tumor response to the treatment.

```{r}
df <- tidycmprsk::trial
df |> glimpse()
```

### desc

5% ä»¥ä¸‹çš„ç¼ºå¤±å¯ä»¥ä¸å¤„ç† (å½“ç„¶ä¹Ÿå¯ä»¥ææ‰)

```{r}
df |> plot_missing()
```

```{r}
df |> count(death_cr)
```

```{r}
df |> 
  mutate(death_cr = fct_relevel(death_cr, 
                                "death from cancer", 
                                "death other causes", 
                                "censor")) |> 
  tbl_summary(by = death_cr, 
              digits = all_continuous() ~ 2,
              missing = "no") |> 
  add_overall() |> 
  modify_footnote(all_stat_cols() ~ "Mean (SD); Median (P25, P75); n (%)") |> 
  modify_caption("Table 1. Basic character") |> 
  bold_labels() 
```

## CIF

-   å…¨äººç¾¤çš„ç»“æœ

å› ä¸ºæœ‰ä¸¤ä¸ªç«äº‰é£é™©, æ‰€ä»¥ä¼šæœ‰ä¸¤ä¸ª tables here


```{r}
fit1 <- cuminc(Surv(ttdeath, death_cr) ~ 1, df)
fit1
```

```{r}
fit1 |> 
  tbl_cuminc(times = c(12, 24),
             label_header = "**Month {time}**") 
```

```{r}
fit1 |> 
  tbl_cuminc(times = c(12, 24),
             outcomes = c("death from cancer", "death other causes"),
             label_header = "**Month {time}**") 
```

-   æˆ‘ä»¬æ‹¿ treatment åˆ†å±‚æ¥çœ‹

```{r}
fit2 <- cuminc(Surv(ttdeath, death_cr) ~ trt, df)
fit2
```

-   `add_p()` Add column with p-value comparing incidence across stratum

```{r}
fit2 |> 
  tbl_cuminc(times = c(12, 24),
             label_header = "**Month {time}**") |> 
  add_p() |> 
  modify_header(p.value ~ "*P*") 
```

```{r}
fit2 |> 
  tbl_cuminc(times = c(12, 24),
             outcomes = c("death from cancer", "death other causes"),
             label_header = "**Month {time}**") |> 
  add_p() |> 
  add_nevent() |> 
  add_n() |> 
  modify_header(p.value ~ "*P*") 
```

```{r}
fit2 |> 
  ggcuminc(outcome = "death from cancer") +
  add_confidence_interval() +
  add_risktable() +
  scale_ggsurvfit(x_scales = list(breaks = seq(0, 24, by = 6))) + 
  scale_color_lancet() + 
  scale_fill_lancet() + 
  theme(legend.position = c(0.2, 0.8))
```

```{r}
fit2 |> 
  ggcuminc(outcome = c("death from cancer", "death other causes")) +
  add_risktable() +
  scale_ggsurvfit(x_scales = list(breaks = seq(0, 24, by = 6))) + 
  scale_color_lancet() + 
  scale_fill_lancet() + 
  theme(legend.position = c(0.2, 0.7))
```

-   using the survival multi-state model

```{r}
survfit2(Surv(ttdeath, death_cr) ~ trt, df) |> 
  ggcuminc(outcome = "death from cancer") +
  add_confidence_interval() +
  add_risktable() +
  scale_ggsurvfit(x_scales = list(breaks = seq(0, 24, by = 6))) + 
  scale_color_lancet() + 
  scale_fill_lancet() + 
  theme(legend.position = c(0.2, 0.7))
```


***

## modelling with FG

ç¨å¾®è®²ä¸€ç‚¹ç‚¹åŸç†, ä¸ç„¶ç›´æ¥æ‹¿æ¨¡å‹æ¥è·‘äº†, ä½†æ˜¯é‡Œé¢åœ¨å¹²å•¥å•Š

- ç«äº‰é£é™©å½±å“å…¶ä»–(éä¿¡æ¯åˆ å¤±)åç»­æ—¶é—´å‘ç”Ÿçš„æ¦‚ç‡

- æ ¸å¿ƒæ˜¯æ„å»º CIF, é€šè¿‡ subdistribution hazard åˆ†æåå˜é‡çš„æ•ˆåº”


$$CIF_k(t) = P(T \leq t, D = k)\tag{1}$$

åœ¨ç»™å®šæ—¶é—´ t, ä¸ªä½“å‘ç”Ÿäº‹ä»¶ k çš„ç¬æ—¶é£é™©, åŒæ—¶è€ƒè™‘äº†å› ç«äº‰äº‹ä»¶é€€å‡ºä½†ä»åœ¨â€œé£é™©ä¸­â€çš„ä¸ªä½“(åŠ æƒ)


**ä¼ ç»Ÿ Cox**

- å…³æ³¨äº‹ä»¶ k çš„ç¬æ—¶é£é™©, ä»…ä»…è€ƒè™‘æœªå‘ç”Ÿä»»ä½•äº‹ä»¶çš„ä¸ªä½“

$$h_k(t) = \lim_{\Delta t \to 0} \frac{P(t \leq T < t + \Delta t, D = k \mid T \geq t)}{\Delta t}\tag{2}$$

**FG**

- é£é™©é›†

    - æœªå‘ç”Ÿä»»ä½•äº‹ä»¶çš„ä¸ªä½“ ($T \geq t$) 
    
    - å·²å› ç«äº‰äº‹ä»¶é€€å‡º ($D \neq k$) ä½†ä»ç„¶â€œåœ¨é£é™©ä¸­â€çš„ä¸ªä½“
    

Subdist. risk function

$$ h_k^{sub}(t) = \lim_{\Delta t \to 0} \frac{P(t \leq T < t + \Delta t, D = k \mid T \geq t \text{ or } (T < t, D \neq k))}{\Delta t} \tag{3}$$



$$h_k^{sub}(t | X) = h_{k0}^{sub}(t) \exp(\beta X) \tag{4}$$

ä¸ CIF çš„å…³ç³»

- åå˜é‡å¯¹åº” $\beta$ å½±å“ subdist. è€Œæ”¹å˜ CIF

$$ CIF_k(t | X) = 1 - \exp\left(-\int_0^t h_k^{sub}(u | X) \, du\right) \tag{5}$$

FG é€šè¿‡åŠ¨æ€è°ƒæ•´é£é™©é›†, ç›´æ¥ä¼°è®¡CIF, ç›´è§‚å¥½è§£é‡Š


**åŠ æƒçš„åŸç†**

$$w_i(t) = \frac{G(t)}{G(T_i)} \tag{6}$$

- $w_i(t)$ ä¸ªä½“ i åœ¨æ—¶é—´ t çš„æƒé‡

- $G(t) = P(T > t)$ æ€»ä½“ç”Ÿå­˜å‡½æ•°ï¼Œè¡¨ç¤ºåœ¨æ—¶é—´ t ä¹‹å‰æœªå‘ç”Ÿä»»ä½•äº‹ä»¶çš„æ¦‚ç‡

- $T_i$ ä¸ªä½“ i å‘ç”Ÿç«äº‰äº‹ä»¶çš„æ—¶é—´  $T_i < t$

- $T_i < t, D \neq k$ æ—¶å€™æƒé‡ç”Ÿæ•ˆ

å›åˆ°äº† $\tag{3}$é‡Œé¢

- åŠ æƒæœºåˆ¶ç¡®ä¿å·²å› ç«äº‰äº‹ä»¶é€€å‡ºçš„ä¸ªä½“å¯¹ç›®æ ‡äº‹ä»¶(äº‹ä»¶k)çš„äºšåˆ†å¸ƒé£é™©ä»æœ‰è´¡çŒ®, åæ˜ å…¶â€œæ½œåœ¨é£é™©â€

- è¡¨ç¤ºä¸ªä½“ i åœ¨é€€å‡ºæ—¶é—´$T_i$ åç»§ç»­ç•™åœ¨é£é™©é›†çš„ç›¸å¯¹æ¦‚ç‡

- æƒé‡éšæ—¶é—´ t é€’å‡, å› ä¸º G(t) éšæ—¶é—´å‡å°, åæ˜ ä¸ªä½“å¯¹åç»­é£é™©çš„è´¡çŒ®é€æ¸é™ä½


**ç›¸è¾ƒäº Cox**

- FG é€šè¿‡åŠ æƒä¿ç•™å·²é€€å‡ºä¸ªä½“, è€Œ Cox ä»…è€ƒè™‘äº† $T \geq t$ çš„ä¸ªä½“


***

```{r}
fit_crr <- crr(Surv(ttdeath, death_cr) ~ trt + age, df)
fit_crr
```

```{r}
fit_crr |> tidy()
```

```{r}
fit_crr |> 
  tbl_regression(exponentiate = T) |> 
  modify_header(p.value ~ "*P*") |>  
  add_n(location = "level")
```

## modelling with Cause-specific Cox

```{r}
fit_cox1 <- coxph(Surv(ttdeath, death_cr == "death from cancer") ~ trt + age, 
                  df)
fit_cox1
```

```{r}
fit_cox2 <- coxph(Surv(ttdeath, death_cr == "death other causes") ~ trt + age, 
                  df)
fit_cox2
```


***

## modelling with Multi-State Model

å¤šä¸ªäº‹ä»¶å‘ç”Ÿçš„è·¯å¾„å’Œè½¬æ¢è¿‡ç¨‹, å¦‚: å…¥ç»„ åˆ° å¤å‘ åˆ°æ­»äº¡

Status â†’ Transitions â†’ Transition Hazard

- æŸäº›é¢„åå› ç´ å¦‚ä½•å½±å“ä¸åŒé˜¶æ®µ

- é¢„æµ‹

**åŸç†**

- çŠ¶æ€ä¹‹é—´çš„è½¬ç§»é£é™© $h_{ij}(t)$ ä¸è½¬ç§»æ¦‚ç‡ $P_{ij}(s, t)$

- é£é™©é›†åŸºäºå½“å‰çŠ¶æ€




**è½¬ç§»é£é™©å‡½æ•°**

$$h_{ij}(t) = \lim_{\Delta t \to 0} \frac{P(t \leq T < t + \Delta t, Stasus_j \mid T \geq t, Stasus_i)}{\Delta t} \tag{7}$$


**è½¬ç§»æ¦‚ç‡**

$$P_{ij}(s, t) = P(Stasus_j \text{ at } t \mid Stasus_i \text{ at } s) \tag{8}$$


**å¤šçŠ¶æ€æ¨¡å‹**

$$h_{ij}(t | X) = h_{ij0}(t) \exp(\beta_{ij} X) \tag{9}$$



```{r}
# Define transition matrix
tmat <- matrix(NA, 3, 3)
tmat[1, 2:3] <- 1:2 # Healthy â†’ Disease (1), Healthy â†’ Death (2)
tmat[2, 3] <- 3     # Disease â†’ Death (3)
dimnames(tmat) <- list(
  from = c("healthy", "disease", "death"),
  to = c("healthy", "disease", "death")
)
tmat
```





***

# Confounding related

EPI é‚£æœ¬ä¹¦ä¸Šé¢çš„ä¸€ä¸ªå›¾å’Œä¾‹å­

![P197. Table 5-8: Hypothetical examples of unadjusted and adjusted relative risks according to type of confounding (positive or negative).](P197_T5_7.png)

![P199. Table 5-9: Directions of the associations of the confounder with the exposure and the outcome](P197_T5_8.png)
