---
title: "3_logis_cut_off"
subtitle: "logis, sens, spec, cut-off"
author: "YYS"
date: "2025-4-6"
toc: true
number-sections: true
format:
  html:
    theme: litera
    df-print: kable
---

**ç°åœ¨çš„æ€è·¯æ··ä¹±äº†, é‡æ–°æ¢³ç†æ€è·¯**


**Question**

è‡ªæ‰¾æ•°æ®åˆ†æ: ç”¨ logistic é¢„æµ‹ç™Œç—‡é£é™©æ—¶, å¦‚ä½•å¹³è¡¡çµæ•åº¦å’Œç‰¹å¼‚åº¦? å¦‚ä½•é€‰æ‹©æœ€ä½³é˜ˆå€¼?


äº‹å®ä¸Šè¿™æ˜¯ä¸¤ä¸ªé—®é¢˜


- ä¸€ä¸ªæ˜¯æ ¹æ®ç–¾ç—…ç‰¹å¾æ¥ balance çµæ•åº¦å’Œç‰¹å¼‚åº¦(è¿™ä¸ªå·²ç»è®²è¿‡äº†)

    - å¯¹åº”çš„ cut-off è¿™æ¡çº¿æ”¾åœ¨å“ªé‡Œ, å„ä¸ªå…¶å®åœ¨é‚£ä¸ªåˆ†å¸ƒå›¾é‡Œé¢ä¹Ÿå·²ç»æœ‰äº†
    
    - å¦‚æœæ‹“å±•å‡ºå», å¯ä»¥è®²çš„ä¸€ä¸ªç‚¹æ˜¯: é€‰ cut-off, è¿™æ˜¯ä¸´åºŠéå¸¸å–œæ¬¢çš„ä¸€ä¸ªé—®é¢˜(ä¸¤ç§åšæ³•)
    
- å¦ä¸€ä¸ªæ˜¯ä»é¢„æµ‹æ¨¡å‹è§’åº¦å»æ•´æ´» (`using logis`)

    - è¿™ä¸ªæ—¶å€™å®Œå…¨å¯ä»¥èµ° `tidymodels` å·¥ä½œæµ
    

```{r setup}
#| include: false
knitr::opts_chunk$set(warning = F, message = F, dpi = 300)
```

```{r}
#| include: false
rm(list = ls())
```

```{r}
options(scipen = 200)
```


# load packages

```{r}
library(tidyverse)
library(tidymodels)
library(patchwork)
library(lmtest)
library(ggsci)
library(MASS)
library(kableExtra)
library(DataExplorer)
library(gtsummary)
library(glmnet)
library(probably)
library(rms)
library(reportROC)
```



# å…³äº  Sens, spec çš„ balance and cut-off

- æˆ‘ä»¬åœ¨ç­›æ£€/è¯Šæ–­è¯•éªŒæ—¶å€™, æœ‰ä¸¤ä¸ªåˆ†å¸ƒçš„é‚£ä¸ªå›¾ (patient and control)

- Sens and Spec äº‹å®ä¸Šå¯¹åº”ç€è¯¯è¯Šçš„æ¼è¯Š

- æˆ‘ä»¬cut-off çš„é€‰æ‹©ï¼Œå…¶å®è·Ÿç–¾ç—…æœ¬èº«æœ‰å…³

    - å®å¯é”™æ€ä¸€åƒï¼Œä¹Ÿä¸æ”¾è¿‡ä¸€ä¸ª(æ›¹æ“)
    
    - å®å¯æ”¾è¿‡ä¸€åƒï¼Œä¹Ÿä¸é”™æ€ä¸€ä¸ª(éƒ­é–)
    
- å¯¹äºæœ‰æ˜ç¡®æ²»ç–—æ–¹æ³•çš„, æ™šå‘ç°(æ¼è¯Š)å¾ˆä¸¥é‡çš„, ä»¥åŠä¼ æŸ“ç—…(COVIDæ—¶å€™æˆ‘ä»¬åšæ ¸é…¸)

    - æˆ‘ä»¬è¦æé«˜Sens, åšä¸‰æ—©

- ä½†æ˜¯å¯¹äº cancer, ç°åœ¨æ˜¯ä¸èƒ½æ²»ç–—çš„, å‘ç°äº†è¿˜ä¸å¦‚ä¸å‘ç°

    - è¯Šæ–­å‡ºæ¥åè€Œç»™æ‚£è€…å¸¦æ¥å¿ƒç†å‹åŠ›ï¼ˆå°¤å…¶å¦‚æœè¯¯è¯Šï¼Œç®€ç›´å°±æ˜¯â€œå®Œäº†ï¼BBQäº†â€ï¼‰
    
    - æˆ‘ä»¬ä¹Ÿçœ‹åˆ°è¿‡ï¼ŒæŠ—ç™Œæ—¥è®°ä¹‹ç±»çš„ï¼Œå¿ƒç†ç–—æ³•æ˜¯æ›´é‡è¦çš„
    
**æ³¨æ„: Sens, Spec åªä¸ç­›æ£€è¯•éªŒæœ¬èº«æœ‰å…³(ä¸€ä¸ªè¯•å‰‚ç›’æœ¬èº«çš„æ€§è´¨)**



# æ¨¡æ‹Ÿåˆ†å¸ƒ

```{r}
set.seed(123)
tibble(
  group = c(rep("Normal", 2000),
            rep("Patient", 20)
            ), 
  value = c(
    rnorm(2000, 50, 5), 
    rnorm(20, 80, 10)
  )
) |> 
  ggplot(aes(value, fill = group)) + 
  geom_density(alpha = 0.4) +
  geom_vline(xintercept = 61.5, lty = 5, color = "#254381", linewidth = 1) + 
  # geom_vline(xintercept = 57, lty = 1, color = "red", linewidth = 1) + 
  scale_fill_lancet() + 
  labs(x = "Value", y = "Density", fill = "Group") + 
  theme_void() + 
  theme(legend.position = c(0.8, 0.8), 
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 16)
        )
```


```{r}
set.seed(123)
tibble(
  group = c(rep("Normal", 2000),
            rep("Patient", 20)
            ), 
  value = c(
    rnorm(2000, 50, 5), 
    rnorm(20, 80, 10)
  )
) |> 
  ggplot(aes(value, fill = group)) + 
  geom_density(alpha = 0.4) +
  geom_vline(xintercept = 67, lty = 5, color = "#C94830", linewidth = 1) + 
  # geom_vline(xintercept = 57, lty = 1, color = "red", linewidth = 1) + 
  scale_fill_lancet() + 
  labs(x = "Value", y = "Density", fill = "Group") + 
  theme_void() + 
  theme(legend.position = c(0.8, 0.8), 
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 16)
        )
```


***

So the first thing, simu data for answering cut-off

the second thing is show the tidymodels workflow


# data simulation


```{r}
set.seed(567) 
n <- 1000  
df <- tibble(
  age = rnorm(n, mean = 60, sd = 10),  
  biomarker = rnorm(n, mean = 0, sd = 1), 
  family_history = rbinom(n, 1, 0.2),
  outcome = rbinom(n, 1, 
                   plogis(-2 + 0.05 * age + 2 * biomarker + 1 * family_history))
) |> 
  mutate(outcome = factor(outcome))
```

## table 1

```{r}
df |> 
  tbl_summary(by = outcome, 
              label = list(family_history ~ "Family history"),
              statistic = list(c("age", "biomarker") ~ "{mean} ({sd})"),
              digits = all_continuous() ~ 2,
              missing = "no") |> 
  add_overall() |> 
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3),
        list(all_continuous() ~ "t.test")) |> 
  modify_footnote(all_stat_cols() ~ "Mean (SD); n (%)") |> 
  modify_header(p.value ~ "*P*") |>  
  modify_caption("Table 1. Basic character") |> 
  bold_labels() 
```



## ordinary modelling

- æˆ‘ä»¬åœ¨è¿™é‡Œå…ˆèµ°ä¼ ç»Ÿçš„åšæ³•, åé¢æ‰“å¼€åšä¸€äº›äº‹æƒ…

```{r}
form_reg <- as.formula(
  paste("outcome ~ ", paste(colnames(df)[1:3], collapse = "+"))
)
form_reg
```

- In `base R` system, æ¥åš logis å¾ˆç®€å•, æŒ‡å®š `link function` å°±è¡Œäº†


```{r}
fit <- glm(form_reg, 
           family = "binomial", 
           data = df)
```

```{r}
fit |> summary()
```

- `summary()` æ¨¡å‹æ‘˜è¦é‡Œé¢æ˜¯æœ‰å¾ˆå¤šé™„åŠ ä¿¡æ¯çš„, ä¸è¦åªç›¯ç€ç³»æ•°çœ‹


### res coef

- æŒ‡æ•°åŒ–å¾—åˆ° OR åŠåŒºé—´

$$exp(b_j) ~~ \& ~~ exp(b_j ~  \pm ~ 1.96 * S_{b_j} )$$
```{r}
fit |> tidy()
fit |> tidy(exponentiate = T)
```


```{r}
fit |> 
  tbl_regression(exponentiate = T) |> 
  modify_header(p.value ~ "*P*")
```


***

è¿˜æœ‰ä¸€äº›æ‚ä¸ƒæ‚å…«ç»“æœå¦‚ æ£®æ—å›¾, åˆ—çº¿å›¾, æ ¡å‡†æ›²çº¿ç­‰ç­‰è¿™é‡Œå°±ä¸æŠ¥å‘Šäº†, å› ä¸ºè¿™æ¬¡æ ¸å¿ƒæ˜¯ `cut-off`

å¯¹åº”çš„ ROC å¯èƒ½æ˜¯å¤§å®¶æ›´æ„Ÿå…´è¶£çš„ä¸œè¥¿

**é‚£ä¹ˆ:**

- ROC åœ¨åšä»€ä¹ˆæ ·çš„äº‹æƒ…? è¿™ä¸ªæ›²çº¿æ˜¯æ€ä¹ˆè¢«ç”»å‡ºæ¥çš„? (note: æ‰€æœ‰å›¾å½¢çš„æœ¬è´¨éƒ½æ˜¯æ•£ç‚¹å›¾)

- ROC ä¸ cut-off çš„å…³ç³»?

    - ä¸´åºŠåŒ»ç”Ÿå¾ˆå–œæ¬¢æ‹¿ ROC æ¥é€‰ cut-off (å¯¹åº”æœ€å·¦ä¸Šè§’çš„ç‚¹), é‚£ä¹ˆè¿™æ ·åšå¯¹ä¹ˆ?
    
    - ä¹‹å‰(åŒ…æ‹¬ç°åœ¨)æœ‰äº›æ–‡ç« é¢˜ç›®ç›´æ¥å°±æ˜¯: "åŸºäºROCæ›²çº¿/åˆ—çº¿å›¾çš„é¢„æµ‹æ¨¡å‹", è¿™æ ·å¯¹ä¹ˆ?
    
- ROC å…¶å®ä¹Ÿæ˜¯æ¨¡å‹çš„ä¸€ä¸ªé™„å±ç»“æœ

    - æ˜¯ç»“æœå‘ˆç°çš„ä¸€ç§å½¢å¼(åƒæ£®æ—å›¾, åˆ—çº¿å›¾é‚£æ ·)
    
    - ä¹Ÿæ˜¯æ¨¡å‹è¯„ä»·çš„ä¸€ä¸ªæŒ‡æ ‡(AUC) 
    
        - å½“ç„¶è¿˜æœ‰ accuracy, sens, spec ç­‰ç­‰æŒ‡æ ‡
    
        - è¿™äº›åœ¨é¢„æµ‹æ¨¡å‹é‡Œé¢æ˜¯å¾ˆé‡è¦çš„
    

## ROC

### using reportROC

- see `?predict.glm` for more detail

- æˆ‘ä»¬åœ¨è¿™é‡Œæ”¾ `type = "response"` å³å¯

```{r}
df_roc <- df |> 
  mutate(y_pred = predict(fit, type = "response"))
```

- `reportROC` è¿™ä¸ªå‡½æ•°åœ¨ ROC å¾ˆå¼ºå•Š, å„ç§æŒ‡æ ‡éƒ½ç»™å‡ºæ¥äº†

```{r}
#| fig-height: 4
#| fig-width: 4
reportROC(gold = df_roc$outcome,
          predictor = df_roc$y_pred,
          important = "sp",
          plot = T)
```


**è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¹Ÿä¼šé—®, è¿™ä¸ª cut-off (0.676) æ˜¯æ€ä¹ˆæ¥çš„?**

    - è¿™ä¸ªåŒ…æ¯•ç«Ÿè¿˜æ˜¯ä¸€ä¸ªå°è£…çš„åŒ… (å½“ç„¶æˆ‘ä»¬å¯ä»¥é€‰ä¸­è¿™ä¸ª, ç„¶å cmd + enter)
    
    - çœ‹ä¸‹é¢çš„ä¾‹å­


***

### using yardstick

```{r}
df_roc |> 
  mutate(y_pred_0 = 1 - y_pred) |> 
  head()
```


```{r}
df_roc |> 
  mutate(y_pred_0 = 1 - y_pred) |> 
  roc_auc(outcome, y_pred_0) 
```


```{r}
df_roc |> 
  mutate(y_pred_0 = 1 - y_pred) |> 
  roc_curve(outcome, y_pred_0) |> 
  sample_n(10)
```


```{r}
df_roc |> 
  mutate(y_pred_0 = 1 - y_pred) |> 
  roc_curve(outcome, y_pred_0) |> 
  ggplot(aes(x = 1 - specificity, 
             y = sensitivity))+
  geom_abline(lty = 2, color = "gray80", 
              linewidth = 1.5) +
  geom_path(alpha = 0.8, linewidth = 1) +
  labs(x = "1 - Specificity", 
       y = "Sensitivity") + 
  coord_equal() +
  theme_classic() + 
  theme(axis.text = element_text(size = 14), 
        axis.title = element_text(size = 14))
```



```{r}
df_roc |> 
  mutate(y_pred_0 = 1 - y_pred) |> 
  roc_curve(outcome, y_pred_0) |> 
  mutate(youden = sensitivity + specificity - 1) |>
  slice_max(youden, n = 1)
```


```{r}
1 - 0.3249796	
```


```{r}
df_roc |> 
  mutate(.pred_class = case_when(y_pred >= 0.6750204 ~ 1,  T ~ 0), 
         .pred_class = factor(.pred_class)) |> 
  conf_mat(outcome, .pred_class)
```


### an example to explain roc_auc in yardstick

```{r}
data(two_class_example)
two_class_example |> head()
```


```{r}
roc_auc(two_class_example, truth, Class1)
```


```{r}
two_class_example |> 
  roc_curve(truth, Class1) |> 
  ggplot(aes(x = 1 - specificity, y = sensitivity))+
  geom_abline(lty = 2, color = "gray80", linewidth = 1.5) +
  geom_path(alpha = 0.8, linewidth = 1) +
  labs(x = "1 - Specificity", y = "Sensitivity") + 
  coord_equal() +
  theme_classic()
```

```{r}
two_class_example |> 
  roc_curve(truth, Class2) |> 
  ggplot(aes(x = 1 - specificity, y = sensitivity))+
  geom_abline(lty = 2, color = "gray80", linewidth = 1.5) +
  geom_path(alpha = 0.8, linewidth = 1) +
  labs(x = "1 - Specificity", y = "Sensitivity") + 
  coord_equal() +
  theme_classic()
```


but if we transfer x and y

```{r}
two_class_example |> 
  roc_curve(truth, Class2) |> 
  ggplot(aes(y = 1 - specificity, x = sensitivity))+
  geom_abline(lty = 2, color = "gray80", linewidth = 1.5) +
  geom_path(alpha = 0.8, linewidth = 1) +
  labs(x = "1 - Specificity", y = "Sensitivity") + 
  coord_equal() +
  theme_classic()
```


***

# tidymodels system

```{r}
df |> glimpse()
```


## modelling

```{r}
set.seed(123)
df_split <- initial_split(df, strata = outcome)
df_train <- training(df_split)
df_test <- testing(df_split)

set.seed(234)
df_folds_bs <- bootstraps(df_train, strata = outcome)
```


```{r}
form_reg <- as.formula(
  paste("outcome ~ ", paste(colnames(df)[1:3], collapse = "+"))
)
form_reg
```

```{r}
df_recipe <- 
  recipe(form_reg, data = df_train)
```

```{r}
glm_spec <- logistic_reg() |> 
  set_engine("glm")

glm_wf <- workflow() |> 
  add_recipe(df_recipe) |> 
  add_model(glm_spec)
```


## res

### metrics

```{r}
yysfun_metric_CI <- function(fmodel) {
  set.seed(567)
  rbind(
    fmodel |>
      fit_resamples(
        resamples = df_folds_bs,
        metrics = metric_set(accuracy, roc_auc, sens, spec # , recall, f_meas
                             ),
        control = control_resamples(save_pred = T)
      ) |>
      int_pctl(alpha = 0.05, times = 1000) |>
      mutate(set = "train")
    ,
    
    fmodel |>
      last_fit(
        df_split,
        metrics = metric_set(accuracy, roc_auc, sens, spec# , recall, f_meas
                             ),
        control = control_resamples(save_pred = T)
      ) |>
      int_pctl(alpha = 0.05, times = 1000) |>
      mutate(set = "test")
  ) |>
    mutate(
      value = sprintf("%.2f", .estimate),
      lower = sprintf("%.2f", .lower),
      upper = sprintf("%.2f", .upper),
      CI = paste(value, " (", lower, ", ", upper, ")", sep = "")
    ) |>
    select(Metric = .metric, CI, set, .estimate, .lower, .upper)
}
```



```{r}
glm_wf |> yysfun_metric_CI()
```

### roc in test

```{r}
roc_data <- glm_wf |> 
  last_fit(df_split) |> 
  collect_predictions() |>
  roc_curve(outcome, .pred_0)
roc_data |> sample_n(20)
```


```{r}
roc_data |> 
  ggplot(aes(x = 1 - specificity, y = sensitivity))+
  geom_abline(lty = 2, color = "gray80", linewidth = 1.5) +
  geom_path(alpha = 0.8, linewidth = 1)+
  labs(color = "AUC in training [AUC (95% CI)]", 
       x = "1 - Specificity", y = "Sensitivity") + 
  coord_equal() +
  scale_color_lancet() +
  theme_classic() +
  labs(title = "ROC in test") + 
  theme(plot.title = element_text(size = 16, face = "bold"),  
        axis.text = element_text(size = 14), 
        axis.title = element_text(size = 14))
```

- æµ‹è¯•é›†æ··æ·†çŸ©é˜µ

```{r}
glm_wf |> 
  last_fit(df_split) |> 
  collect_predictions() |> 
  conf_mat(outcome, .pred_class)
```


# next step æ˜ å°„å›å»

ä¸‹ä¸€ä¸ªäº‹æƒ…æ˜¯æ‰¾æœ€ä½³é˜ˆå€¼(åŒæ—¶æ§åˆ¶å…¶ä»–å˜é‡)

- å›ºå®šå…¶ä»–å˜é‡åœ¨å‡å€¼æ°´å¹³, ç„¶åé€šè¿‡åå‘ logit æ˜ å°„å›å»


```{r}
youden <- roc_data |>
   mutate(youden = sensitivity + specificity - 1) |>
   slice_max(youden, n = 1)
youden
```


é©¬ä¸Šä¼šè¯´, è¯¶, æˆ‘ä»¬å‰é¢ä¸æ˜¯ 0.32å—? è¿™é‡Œ `.threshold` æ€ä¹ˆ 0.34äº† 

- å› ä¸ºå‰é¢æ˜¯ full data set, è€Œè¿™é‡Œæ˜¯ in test set

```{r}
optimal_prob <- youden$.threshold
```

```{r}
final_fit <- glm_wf |> 
  last_fit(df_split) |> 
  extract_fit_parsnip()

coef <- coef(final_fit$fit)
intercept <- coef[1]
coef_age <- coef["age"]
coef_biomarker <- coef["biomarker"]
coef_fh <- coef["family_history"]
```


- **å›ºå®šåå˜é‡ä¸ºå‡å€¼**

```{r}
mean_age <- mean(df_test$age)
mean_fh <- mean(df_test$family_history)
```


åæ¨ biomarker çš„ cut-off (æ˜ å°„å›å»)

```{r}
fixed_logit <- 
  intercept + 
  coef_age * mean_age + 
  coef_fh * mean_fh

logit_optimal <- 
  log(optimal_prob / (1 - optimal_prob))

biomarker_cutoff <- 
  (logit_optimal - fixed_logit) / coef_biomarker
biomarker_cutoff
```


```{r}
glm_wf |> 
  last_fit(df_split) |> 
  collect_predictions() |>
  bind_cols(df_test) |> 
  rename(outcome = outcome...6) |> 
  ggplot(aes(x = biomarker, y = .pred_1, color = outcome)) +
  geom_point(alpha = 0.5) +
  # geom_hline(yintercept = optimal_prob, linetype = "dashed", color = "red") +
  geom_vline(xintercept = biomarker_cutoff, 
             lty = 2, size = 1, alpha = 0.8, 
             color = "blue") +
  scale_color_lancet() + 
  labs(x = "Biomarker", y = "Predicted Probability", 
       color = "Outcome") +
  theme_classic() +
  theme(legend.position = c(0.8, 0.2),
        axis.text = element_text(size = 14), 
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 14), 
        legend.title = element_text(size = 14))
```


# if single biomarker

```{r}
fit_s <- glm(outcome ~ biomarker, family = "binomial", data = df)
```


```{r}
#| fig-height: 4
#| fig-width: 4
df_roc_2 <- df |> 
  mutate(y_pred_2 = predict(fit_s, type = "response"))

reportROC(gold = df_roc_2$outcome,
          predictor = df_roc_2$y_pred_2,
          important = "sp",
          plot = T)
```

***

```{r}
rm(list = ls())
```

***

# Q2 WLS

## simu data

```{r}
set.seed(567)
df_1 <- tibble(
  x = c(1:500), 
  y = 10 + 2 * x + rnorm(500, 0, 10)
)
```

```{r}
set.seed(567)
df_2 <- tibble(
  x = c(1:500), 
  y = 10 + 2 * x + rnorm(500, 0, x)
)
```

## dist

```{r}
#| fig-width: 8
#| fig-height: 4
#| output-location: slide
df_1 |> 
  ggplot(aes(x, y)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Equal variance")|
df_2 |> 
  ggplot(aes(x, y)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Non-equal variance")
```


## linear regression

```{r}
mod1 <- lm(y ~ x, df_1)
mod2 <- lm(y ~ x, df_2)
```

æ¨¡å‹ç»“æœæ‘˜è¦

```{r}
yysfun_summary <- function(model) {
  s <- model |> summary()
  s |> tidy() |>
    filter(term != "(Intercept)") |>
    mutate(
      estimate = sprintf("%.3f", estimate), 
      std.error = sprintf("%.3f", std.error), 
      statistic = sprintf("%.3f", statistic),
      R2 = sprintf("%.3f", s$r.squared),
      Radj2 = sprintf("%.3f", s$adj.r.squared),
      p.value = case_when(p.value < 0.001 ~ "< 0.001",
                          TRUE ~ as.character(p.value))
    ) |>
    rename(`Î²` = estimate,
           S.E. = std.error,
           P = p.value)
}
```


```{r}
#| tbl-cap: "Comparision of 2 models"
rbind(
  yysfun_summary(mod1) |> mutate(model = "Equal variance", .before = 1),
  yysfun_summary(mod2) |> mutate(model = "Non-equal variance", .before = 1)
)
```


ğŸ’  **å¯ä»¥å‘ç°**:

-   æ–¹å·®ä¸é½æ—¶å€™, æ ‡å‡†è¯¯(S.E.)ä¸Šæ¥äº†

-   $R^2$ å’Œ $R_{adj}^2$ å‡å˜å°


### æ®‹å·® residual

```{r}
yysfun_resi <- function(model, df){
  model |> residuals() |> 
  as.tibble() |> 
  mutate(x = df$x) |> 
  ggplot(aes(x, value)) +
  geom_hline(yintercept = 0, lty = 2, color = "#75AADB", size = 1.5) +
  geom_point() +
  labs(y = "Residual")
}
```

```{r}
#| fig-width: 8
#| fig-height: 4
#| output-location: slide
p1 <- yysfun_resi(mod1, df_1) + labs(title = "Equal variance")
p2 <- yysfun_resi(mod2, df_2) + labs(title = "Non-equal variance")
p1|p2
```

ğŸ’  **å¾ˆæ˜æ˜¾**

-   æ–¹å·®é½çš„æ—¶å€™(å·¦å›¾), å¤§éƒ¨åˆ†(`95.44%`) $\epsilon_i$ åœ¨ $\mu - 2 \sigma$(å³-20) åˆ° $\mu + 2 \sigma$(å³20)ä¹‹é—´

-   æ–¹å·®ä¸é½æ—¶å€™(å³å›¾), æ®‹å·®å¤šä¹ˆæ˜æ˜¾çš„**å–‡å­å£çŠ¶**



## å¤„ç†æ–¹å·®ä¸é½

### OLS + ç¨³å¥ä¼°è®¡

**ç¨³å¥æ ‡å‡†è¯¯**

```{r}
mod2_1 <- rlm(y ~ x, df_2)
mod2_1 |> summary()
```

ğŸ’  **å¯ä»¥çœ‹åˆ°**:

-   x çš„ç³»æ•°`2.0167`, æ¯” `model 2` çš„ç³»æ•°(2.0513)æ›´æ¥è¿‘ `2`


### WLS åŠ æƒæœ€å°äºŒä¹˜

-   ä¸å¹³ç­‰å¯¹å¾…è¿™äº›ç‚¹, æŠŠè¿œçš„ç‚¹æ‹‰å›æ¥

-   è®¾ç½®**æƒé‡**æ˜¯\[æ®‹å·®çš„ç»å¯¹å€¼çš„å€’æ•°\]

```{r}
res <- mod2 |> residuals()
mod2_2 <- lm(y ~ x, df_2, weights = 1/abs(res))
mod2_2 |> summary()
```


```{r}
#| tbl-cap: "Comparision of 3 models"
rbind(
  yysfun_summary(mod1) |> mutate(model = "Equal variance", .before = 1),
  yysfun_summary(mod2) |> mutate(model = "Non-equal variance", .before = 1),
  yysfun_summary(mod2_2) |> mutate(model = "Non-equal with WLS", .before = 1)
)
```

ğŸ’  **å¯ä»¥çœ‹åˆ°**

-   æ ‡å‡†è¯¯(S.E.)å˜å°äº†(ç¬¬ä¸‰è¡Œç›¸è¾ƒäºç¬¬äºŒè¡Œ)

-   $R^2$ å’Œ $R_{adj}^2$ å‡å˜å¤§(å›æ¥äº†), ä¸”æ¥è¿‘ç¬¬ä¸€è¡Œ(`model 1`)